{% extends 'base.html' %}
{% block head %}
<title>jQuery UI Slider - Default functionality</title>
<!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>
  <script src="https://d3js.org/d3.v2.min.js"></script>
<script>
window.onload=function(){
                  document.getElementById('myVideo').addEventListener('loadedmetadata', function() {
                  {% if full %}
                    this.currentTime = parseInt(localStorage.getItem('elapsedtime'));
                    {% if id %}
                      localStorage.id = {{id}}
                    {% endif %}
                  {% else %}
                    localStorage.id = {{id}}
                    this.currentTime = {{start}}
                  {% endif %}
                  console.log("loaded");
                },
                false)
              };
</script>
{% endblock %}
{% block body %}
<div class="container wrapper">
  <h2>Departmental Store scenerio:</h2>
  <p><em>Play the video when you are ready.</em></p>
  <div class="separator"></div>
  <div class="container-fluid">
    <div class="modal-body row">
      <div class="col-md-6">
        <div align="center" class="embed-responsive embed-responsive-16by9">
          <video class="embed-responsive-item" id="myVideo" controls>
              {% load staticfiles %}
              <source src="{% static 'account/media/grumpy_customer.mp4' %}" type="video/mp4">
              <source src="movie.ogg" type="video/ogg">
              Your browser does not support the video tag.
          </video>
          <canvas style="display:none"></canvas>
          <img id="img"></img>
        </div>

      </div>
      <div class="col-md-6">

          <h2>Context:</h2><br>
          <p>Departmental store training example: A departmental store employee attending a customer.</p>
      </div>
    </div>
  </div>
    <button type="button" class="btn btn-toggle" data-toggle="button" aria-pressed="false" autocomplete="off"></button>
  <hr/>

</div>
<div class="modal" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Do you want to replay the video?</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="proceed">Proceed</button>
        <button type="button" class="btn btn-success" id="replay" data-dismiss="modal">Replay</button>
      </div>
    </div>
  </div>
</div>
<script>

//var pausetime=2;
var video = document.getElementById("myVideo");
video.addEventListener("timeupdate", function(){
// check whether we have passed 5 minutes,
// current time is given in seconds
  // var video = document.querySelector('video');
  // var canvas = document.querySelector('canvas');
  // var context = canvas.getContext('2d');
  // var w,h,ratio;
  // ratio = video.videoWidth / video.videoHeight;
  // // Define the required width as 100 pixels smaller than the actual video's width
  // w = video.videoWidth - 100;
  // // Calculate the height based on the video's width and the ratio
  // h = parseInt(w / ratio, 10);
  // // Set the canvas width and height to the values just calculated
  // canvas.width = w;
  // canvas.height = h;
  endOffset = {% if full %}parseInt(localStorage.getItem('elapsedtime'))+5{% else %}{{start}}+5{% endif %};
  if(this.currentTime >= endOffset) {
    video.pause();
    $(".modal").modal('show');
  }
});
$("#proceed").on('click',function() {
  console.log('clicked');
  var video = document.getElementById("myVideo");
  // pause the playback
  {% if full %}localStorage.elapsedtime = video.currentTime;{% endif %}
  // context.drawImage(video, 0, 0, w, h);
  // var img = canvas.toDataURL();
  // var storageFiles = {"img":img};
  // localStorage.width = w;
  // localStorage.height = h;
  // localStorage.setItem('img',JSON.stringify(storageFiles));
  if (localStorage.id && ("{{full}}" == "True")){
    window.location.href="/home/questionaire?full={{full}}&id="+localStorage.id;
  }
  else if ({{id}}){
    window.location.href="/home/questionaire?full={{full}}&id={{id}}";
  }
  else{
    window.location.href="/home/questionaire?full={{full}}";
  }
})
$("#replay").on("click",function() {
  var video = document.getElementById("myVideo");
  video.currentTime = video.currentTime - 5;
  video.play();
})
</script>
  <!--<script src="{%static 'account/js/faceDetection.min.js'%}"></script>
  <script type="text/javascript">
    setTimeout(function(){
    window.location.href="/home/questionaire/";},20000);
  </script>
  <script type="text/javascript">
    $("#detect").click(function(){
    alert("Detecting Face ..............");
    jQuery( document ).ready(function( $ ) {
    $(".embed-responsive-item").faceDetection({
      complete:function(faces){
        alert("Detection Complete");
        for(var i=0;i<faces.length;i++){
          $('<div>',{
            'class':'face',
            'css':{
              'position':'absolute',
              'left':faces[i].x*faces[i].scaleX+'px',
              'top':faces[i].y*faces[i].scaleY+'px',
              'width':faces[i].width*faces[i].scaleX+'px',
              'height':faces[i].height*faces[i].scaleY+'px'
            }
          })
          .insertAfter(this);
        }
      },
      error:function(code,message){
        alert("Error: "+message);
      }
    });});
    });
  </script>-->


{% endblock %}
