{% extends 'base.html' %}
{% load staticfiles %}
{% block head %}
<script src="{%static 'account/js/emotion_labeler.js'%}"></script>
<!--<script>
window.onload=function(){
                  document.getElementById('myVideo').addEventListener('loadedmetadata', function() {
                  {% if full %}
                    this.currentTime = parseInt(localStorage.getItem('elapsedtime'));
                    {% if id %}
                      localStorage.id = {{id}}
                    {% endif %}
                  {% else %}
                    localStorage.id = {{id}}
                    this.currentTime = {{start}}
                  {% endif %}
                  console.log("loaded");
                },
                false)
              };
</script>-->
{% endblock %}

{% block body %}
<div class="container wrapper">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-6">
        <div align="center" class="embed-responsive embed-responsive-16by9">
          <!-- Jean's change starts here -->
          <video class="embed-responsive-item" id="myVideo">
              {% load staticfiles %}
              <source src="{% static 'account/media/grumpy_customer.mp4' %}" type="video/mp4">
              <source src="movie.ogg" type="video/ogg">
              Your browser does not support the video tag.
          </video>
          <canvas style="display:none"></canvas>
          <img id="img"></img>
        </div>
        <br/>
        <div class="row">
          <div class="col-sm-2">
            <div id='controls'>
              <button id='btnPlayPause' class='play' title='play' accesskey="P" onclick='playPauseVideo();'>
                <img id='playpauseimg' src="{% static 'account/img/icon_round_play.png' %}" style="width:30px"></img>
              </button>
            </div>
          </div>
			    <!--progress id='progress-bar' min='0' max='100' value='0'>0% played
            <span class="pop-over" data-toggle="tooltip" data-placement="bottom" title="tag"> </span>
          </progress-->
          <div class="col-sm-10">
            <div class="barWrapper">
              <div id='progress' class="progress">
                <div id='progress-bar' class="progressBar" role="progressbar" style="width:100%; height:20px;" aria-valuenow="1" aria-valuemin="0" aria-valuemax="100">
                  <span id='pr-bar-tooltip' class="popOver" data-toggle="tooltip" data-html="true" data-placement="bottom" title="<a href='#' id='tag-tooltip' style='color:black'>tag</a>"></span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Jean's change ends here -->
      </div>
      <div id="label_pane" class="col-md-6">
        <img id="figure_image" src="{% static 'account/img/customer_1.png' %}">
        <div id="labeler" style="display:block; margin:auto"></div>
        <button id='Add_button' class='btn btn-primary' style="float:right" disabled>Add</button>
        <script>
          generate_circular_labeler('labeler')
        </script>
      </div>
    </div>
  </div>
  <form method='POST'>
    {% csrf_token %}
    <input type='text' name='result_json_string' style="display:none"></input>
    <button class='btn btn-success' type='submit' style="float:right; margin-top:15px; margin-right:15px;" disabled>Submit</button>
  </form>

</div>
<div class="modal" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Do you want to replay the video?</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="proceed">Proceed</button>
        <button type="button" class="btn btn-success" id="replay" data-dismiss="modal">Replay</button>
      </div>
    </div>
  </div>
</div>

<script>

//var pausetime=2;
var video = document.getElementById("myVideo");
video.addEventListener("timeupdate", function(){
// check whether we have passed 5 minutes,
// current time is given in seconds
  // var video = document.querySelector('video');
  // var canvas = document.querySelector('canvas');
  // var context = canvas.getContext('2d');
  // var w,h,ratio;
  // ratio = video.videoWidth / video.videoHeight;
  // // Define the required width as 100 pixels smaller than the actual video's width
  // w = video.videoWidth - 100;
  // // Calculate the height based on the video's width and the ratio
  // h = parseInt(w / ratio, 10);
  // // Set the canvas width and height to the values just calculated
  // canvas.width = w;
  // canvas.height = h;
  endOffset = {% if full %}parseInt(localStorage.getItem('elapsedtime'))+30{% else %}{{start}}+30{% endif %};
  if(this.currentTime >= endOffset) {
    video.pause();
    $(".modal").modal('show');
  }
});
$("#proceed").on('click',function() {
  console.log('clicked');
  var video = document.getElementById("myVideo");
  // pause the playback
  {% if full %}localStorage.elapsedtime = video.currentTime;{% endif %}
  // context.drawImage(video, 0, 0, w, h);
  // var img = canvas.toDataURL();
  // var storageFiles = {"img":img};
  // localStorage.width = w;
  // localStorage.height = h;
  // localStorage.setItem('img',JSON.stringify(storageFiles));
  if (localStorage.id && ("{{full}}" == "True")){
    window.location.href="/home/questionaire?full={{full}}&id="+localStorage.id;
  }
  else if ({{id}}){
    window.location.href="/home/questionaire?full={{full}}&id={{id}}";
  }
  else{
    window.location.href="/home/questionaire?full={{full}}";
  }
})
$("#replay").on("click",function() {
  var video = document.getElementById("myVideo");
  video.currentTime = video.currentTime - 30;
  video.play();
})

</script>

<!-- Jean added -->
<script src="{% static 'account/js/interactive_progress_bar.js' %}"></script>

  <!--<script src="{%static 'account/js/faceDetection.min.js'%}"></script>
  <script type="text/javascript">
    setTimeout(function(){
    window.location.href="/home/questionaire/";},20000);
  </script>
  <script type="text/javascript">
    $("#detect").click(function(){
    alert("Detecting Face ..............");
    jQuery( document ).ready(function( $ ) {
    $(".embed-responsive-item").faceDetection({
      complete:function(faces){
        alert("Detection Complete");
        for(var i=0;i<faces.length;i++){
          $('<div>',{
            'class':'face',
            'css':{
              'position':'absolute',
              'left':faces[i].x*faces[i].scaleX+'px',
              'top':faces[i].y*faces[i].scaleY+'px',
              'width':faces[i].width*faces[i].scaleX+'px',
              'height':faces[i].height*faces[i].scaleY+'px'
            }
          })
          .insertAfter(this);
        }
      },
      error:function(code,message){
        alert("Error: "+message);
      }
    });});
    });
  </script>-->


{% endblock %}
